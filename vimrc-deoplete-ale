" init.nvim - using deoplete and w0rp/ale
" optional settings for neomake commented out
" uncomment and comment out ale settings to change
"
" Command abbreviation function
function! Cabbrev(key, value) abort
    " create command alias safely, see https://bit.ly/2ImFOpL
    " the following two functions are taken from answer below on SO
    " https://stackoverflow.com/a/10708687/6064933

    execute printf('cabbrev <expr> %s (getcmdtype() == ":" && getcmdpos() <= %d) ? %s : %s',
    \ a:key, 1+len(a:key), Single_quote(a:value), Single_quote(a:key))
endfunction

function! Single_quote(str) abort
    return "'" . substitute(copy(a:str), "'", "''", 'g') . "'"
endfunction

" ============================================================================
let vimplug_exists=expand('~/.vim/autoload/plug.vim')

let g:vim_bootstrap_langs = "c,html,javascript,python"
let g:vim_bootstrap_editor = "vim"				" nvim or vim

if !filereadable(vimplug_exists)
  if !executable("curl")
    echoerr "You have to install curl or first install vim-plug yourself!"
    execute "q!"
  endif
  echo "Installing Vim-Plug..."
  echo ""
  silent exec "!\curl -fLo " . vimplug_exists . " --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim"
  let g:not_finish_vimplug = "yes"

  autocmd VimEnter * PlugInstall
endif

" Required:
call plug#begin(expand('~/.vim/plugged'))

"*****************************************************************************
" ============================================================================
" Active plugins
" You can disable or add new ones here:

" this needs to be here, so vim-plug knows we are declaring the plugins we
" want to use
call plug#begin(expand('~/.vim/plugged'))


" Deoplete (different loading for Neovim vs Vim)
if has('nvim')
	Plug 'Shougo/deoplete.nvim', { 'do': ':UpdateRemotePlugins' }
else
	Plug 'Shougo/deoplete.nvim'
	Plug 'roxma/nvim-yarp'
	Plug 'roxma/vim-hug-neovim-rpc'
endif

" Asynchrynous Linting Engine and formatter
Plug 'w0rp/ale'
" Plug 'neomake/neomake'
" Plug 'sbdchd/neoformat'

" Javascript Plugins
"Plug 'carlitux/deoplete-ternjs'

" Javascript syntax and indentation
Plug 'pangloss/vim-javascript'


"Typescript Plugins
"Plug 'HerringtonDarkholme/yats.vim'
"Plug 'mhartington/nvim-typescript', {'do': './install.sh'}

"Python Plugins
Plug 'zchee/deoplete-jedi', { 'for': 'python' }
Plug 'davidhalter/jedi-vim', { 'for': 'python' }

" python syntax highlighting and more
Plug 'numirias/semshi', { 'do': ':UpdateRemotePlugins', 'for': 'python' }

" Change Conda environments in vim
Plug 'cjrh/vim-conda'

" C/C++ completion
Plug 'Shougo/deoplete-clangx'
Plug 'Shougo/neoinclude.vim'

" Better Language Packs
Plug 'sheerun/vim-polyglot'

" highlight URLs inside vim
Plug 'itchyny/vim-highlighturl'

" open URL in browser
Plug 'tyru/open-browser.vim'

" Terminal Vim with 256 colours
"Plug 'fisadev/fisa-vim-colorscheme'

" Monokai colourscheme
Plug 'crusoexia/vim-monokai'

" NeoSolarized truecolor theme
Plug 'iCyMind/NeoSolarized'

" Enter brackets, quotes etc. in pairs
Plug 'Townk/vim-autoclose'

" Rainbow Parentheses
Plug 'luochen1990/rainbow'

" neovim-qt (loaded in neovim only)
if has('nvim')
    Plug 'equalsraf/neovim-gui-shim'
endif

" Airline
Plug 'vim-airline/vim-airline'
Plug 'vim-airline/vim-airline-themes'

" Display indentation lines
Plug 'Yggdroot/indentLine'

" Commenter
Plug 'scrooloose/nerdcommenter'

" Tree browser
Plug 'scrooloose/nerdtree'

" Code Folding
Plug 'tmhedberg/SimpylFold'

" R support in Vim
Plug 'jalvesaq/Nvim-R'

" Julia support
Plug 'JuliaEditorSupport/julia-vim'
Plug 'jpalardy/vim-slime'

" Initialise plugin system
call plug#end()
" ==================================

"{{ vim-plug settings
" use shortnames for common vim-plug command to reduce typing
" To use these shortcut: first activate command line with `:`, then input the
" short alias name, e.g., `pi`, then press <space>, the alias will be expanded
" to the original command automatically
call Cabbrev('pi', 'PlugInstall')
call Cabbrev('pud', 'PlugUpdate')
call Cabbrev('pug', 'PlugUpgrade')
call Cabbrev('ps', 'PlugStatus')
call Cabbrev('pc', 'PlugClean')
"}}

" Put your non-Plugin stuff after this line
"========================================================
"Neovim settings

"{{ auto-completion related
"""""""""""""""""""""""""""" deoplete settings""""""""""""""""""""""""""
" wheter to enable deoplete automatically after start nvim
let g:deoplete#enable_at_startup = 0

" start deoplete when we go to insert mode
augroup deoplete_start
    autocmd!
    autocmd InsertEnter * call deoplete#enable()
augroup END

" maximum candidate window length
call deoplete#custom#source('_', 'max_menu_width', 80)

" minimum character length needed to start completion,
" see https://goo.gl/QP9am2
call deoplete#custom#source('_', 'min_pattern_length', 1)

call deoplete#custom#source('_', {
    \ 'filetype': ['python'],
    \ 'disabled_syntaxes': ['Comment']
    \ })

" ignore certain sources, because they only cause noise most of the time
call deoplete#custom#option('ignore_sources', {
   \ '_': ['around', 'buffer', 'tag']
   \ })

" candidate list item limit
call deoplete#custom#option('max_list', 30)

"The number of processes used for the deoplete parallel feature.
call deoplete#custom#option('num_processes', 16)

" Delay the completion after input in milliseconds.
call deoplete#custom#option('auto_complete_delay', 100)

" enable or disable deoplete auto-completion
call deoplete#custom#option('auto_complete', v:true)

" C/C++ autocomplete via clang
call deoplete#custom#var('clangx', 'clang_binary', '/usr/bin/clang-7')

" Neomake settings
" if not already installed, install flake8 and eslint:
" pip3 install flake8
" or install pylint as an alternative, and change option below
" sudo npm install -g eslint
"let g:neomake_python_enabled_makers = ['flake8']
"let g:neomake_javascript_enabled_makers = ['eslint']
"call neomake#configure#automake('nrwi', 500)
"let g:neomake_open_list = 2

" Neoformat settings - convert tabs to spaces, align and strip trailing spaces
" If not already installed:
" sudo npm install -g prettier
" pip3 install yapf
" sudo apt install astyle
" let g:neoformat_basic_format_align = 1
" let g:neoformat_basic_format_retab = 1
" let g:neoformat_basic_format_trim = 1
" let g:neoformat_enabled_python = ['yapf']
" let g:neoformat_enabled_javascript = ['prettier']

" automatically close the autocomplete preview window when finished
autocmd! CompleteDone * if pumvisible() == 0 | pclose | endif

" disable vim-polyglot for python
let g:polyglot_disabled = ['python', 'javascript']

" vim slime
if !has('nvim')
    let g:slime_target = "vimterminal"
else
    let g:slime_target = "neovim"
endif

" Change mapleader to comma ','
let mapleader = ','

" Line numbers
set number relativenumber

"tabs and spaces
set expandtab
set tabstop=4
set softtabstop=4
set shiftwidth=4

" Set for UTF-8
set encoding=utf-8

" Enable syntax highlighting
syntax enable

"Clipboard settings - unnamed for Windows or MacOS
" unnamedplus for Unix/Linux
set clipboard^=unnamed,unnamedplus

" Copy to clipboard
vnoremap  <leader>y  "+y
nnoremap  <leader>Y  "+yg_
nnoremap  <leader>y  "+y
nnoremap  <leader>yy  "+yy

" Paste from clipboard
nnoremap <leader>p "+p
nnoremap <leader>P "+P
vnoremap <leader>p "+p
vnoremap <leader>P "+P


" Set character for indented lines
let g:indentLine_char = '‚îÜ'

" Key combos for split screens:
"
"    Ctrl+J move to the split below
"    Ctrl+K move to the split above
"    Ctrl+L move to the split to the right
"    Ctrl+H move to the split to the left
nnoremap <C-J> <C-W><C-J>
nnoremap <C-K> <C-W><C-K>
nnoremap <C-L> <C-W><C-L>
nnoremap <C-H> <C-W><C-H>

" Nerdtree settings
" <Ctrl-n> to activate Nerdtree
map <C-n> :NERDTreeToggle<CR>

" Close nvim if Nerdtree is the only window open
autocmd bufenter * if (winnr("$") == 1 && exists("b:NERDTree") && b:NERDTree.isTabTree()) | q | endif

" Define Nerdtree arrows
let g:NERDTreeDirArrowExpandable = '‚ñ∏'
let g:NERDTreeDirArrowCollapsible = '‚ñæ'

" Default python locations
" let g:python_host_prog = '/usr/bin/python2'

let g:python3_host_prog = '/usr/bin/python3'

" F4 brings up conda change environment command
map <F4> :CondaChangeEnv<CR>

" fix problems with uncommon shells (fish, xonsh) and plugins running commands
" (neomake, ...)
" For Linux, set shell as:
set shell=/bin/bash
" For Termux
" set shell=/data/data/com.termux/files/usr/bin/bash

" Asynchronous Linting Engine (ALE)
" ---------------------------------
" leader+l = manual ALE linting
nnoremap <leader>l :ALELint<CR>
"
"Configure ALE to jump between linting errors:
" [c - to previous error
" ]c - to next error
nmap <silent> [c <Plug>(ale_previous_wrap)
nmap <silent> ]c <Plug>(ale_next_wrap)
"
" Change ALE warning signs
let g:ale_sign_error = '>>'
let g:ale_sign_warning = '--'
"
let g:ale_lint_on_text_changed = 'normal'
let g:ale_lint_on_insert_leave = 1

let g:ale_fixers = {
\   '*': ['remove_trailing_lines', 'trim_whitespace'],
\   'javascript': ['prettier', 'eslint'],
\   'python': ['yapf', 'flake8'],
\   'c': ['clangd', 'clang-format'],
\   'cpp': ['clangd', 'clang-format']
\}

" ALE to display warnings in airline
let g:airline#extensions#ale#enabled = 1

" Airline ------------------------------
let g:airline_powerline_fonts = 1
let g:airline_theme = 'papercolor'
let g:airline#extensions#whitespace#enabled = 0

"Enable the list of buffers
let g:airline#extensions#tabline#enabled = 1

"Show just the filename
let g:airline#extensions#tabline#fnamemod = ':t'


" Airline unicode symbols
" Uncomment these and disable the Powerline symbols to use
"let g:airline_left_sep = '‚ñ∂'
"let g:airline_right_sep = '‚óÄ'
"let g:airline_left_sep = '¬ª'
"let g:airline_right_sep = '¬´'
"let g:airline_symbols.readonly = 'üîí'
"let g:airline_symbols.linenr = '‚ò∞'
"let g:airline_symbols.maxlinenr = '„èë'
"let g:airline_symbols.branch = '‚éá'
"let g:airline_symbols.paste = 'œÅ'
"let g:airline_symbols.notexists = '‚àÑ'

" Colour schemes
let g:monokai_term_italic = 1
let g:monokai_gui_italic = 1

if has('gui_running')
  	" Solarized colourscheme in gui (Gvim) mode.
    set guifont=Deja\ Vu\ Mono\ for\ Powerline\ 14
    set termguicolors
    set background=light
	colorscheme NeoSolarized
else
    " monokai colour scheme in text mode
    set termguicolors
  	colorscheme monokai
endif

" Fisadev's dark colour scheme is a nice alternative in text mode
" let &t_Co = 256
" colorscheme fisa
" AirlineTheme powerlineish

" Two new user-defined commands to select Monokai or NeoSolarized colours
command SolarDark set background=dark | colorscheme NeoSolarized
command MonoKai colorscheme monokai
command SolarLight set background=light | colorscheme NeoSolarized

" Rainbow Parentheses
let g:rainbow_active = 1
